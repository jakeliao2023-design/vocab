<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>æ³°è¯­â†”ä¸­æ–‡ èƒŒè¯å°æµ‹ Â· åœ¨çº¿ç‰ˆ (Firebase)</title>
<style>
  :root { --bg:#f6f7fb; --card:#ffffff; --text:#1f2328; --muted:#6a737d; --accent:#0a7; --danger:#c00; }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans SC","PingFang SC","Hiragino Sans GB","Microsoft YaHei UI","Microsoft YaHei",sans-serif;line-height:1.6}
  header{position:sticky;top:0;background:linear-gradient(180deg,#fff,rgba(255,255,255,0.85));backdrop-filter:blur(6px);border-bottom:1px solid #eee;z-index:9}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  h1{font-size:20px;margin:8px 0}
  .card{background:var(--card);border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,0.04);padding:16px;margin:16px 0}
  textarea{width:100%;min-height:140px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;border-radius:10px;border:1px solid #ddd;padding:12px;box-sizing:border-box}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .btn{appearance:none;border:none;border-radius:10px;padding:10px 14px;cursor:pointer;background:#111;color:#fff}
  .btn.alt{background:#eaeef2;color:#111}
  .btn.accent{background:var(--accent);color:#fff}
  .btn.danger{background:var(--danger);color:#fff}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .pill{padding:4px 8px;background:#eef2f7;border-radius:999px;font-size:12px}
  .muted{color:var(--muted);font-size:14px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
  .option{border:1px solid #ddd;border-radius:10px;padding:12px;cursor:pointer;background:#fff;text-align:left}
  .option.correct{border-color:#0a7;background:#eafff6}
  .option.wrong{border-color:#d00;background:#ffecec}
  .prompt{font-size:28px;font-weight:700;margin:6px 0 12px;word-break:break-word}
  .stats{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  progress{width:180px;height:14px}
  .footer{font-size:12px;color:#8a8f98;margin-top:18px}
  input[type="text"]{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px;font-size:18px}
  details summary{cursor:pointer}
  code{background:#f1f5f9;border:1px solid #e2e8f0;border-radius:6px;padding:2px 6px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>æ³°è¯­â†”ä¸­æ–‡ èƒŒè¯å°æµ‹ Â· åœ¨çº¿ç‰ˆ (Firebase)</h1>
    <div class="muted">âœ… äº‘ä¿å­˜ï¼ˆåŒ¿åç™»å½•ï¼‰ã€€âœ… é”™é¢˜æœ¬/åªç»ƒé”™é¢˜ã€€âœ… è½»é‡SRSã€€âœ… æœ¬åœ°å¤‡ä»½</div>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <div class="row">
      <b>äº‘ç«¯</b>
      <button class="btn accent" id="btnSignIn">åŒ¿åç™»å½•</button>
      <button class="btn alt" id="btnSignOut" disabled>é€€å‡º</button>
      <span class="pill" id="uid">æœªç™»å½•</span>
      <button class="btn alt" id="btnCloudSave" disabled>ä¿å­˜åˆ°äº‘ç«¯</button>
      <button class="btn alt" id="btnCloudLoad" disabled>ä»äº‘ç«¯è¯»å–</button>
      <span class="muted">ä¸Šé™ï¼š<b id="limit"></b> æ¡</span>
    </div>
    <details class="muted" style="margin-top:8px"><summary>å¦‚ä½•éƒ¨ç½²ï¼Ÿï¼ˆä¸€æ¬¡æ€§ï¼‰</summary>
      <ol>
        <li>åˆ° <a href="https://console.firebase.google.com/" target="_blank">Firebase Console</a> åˆ›å»ºé¡¹ç›®ï¼Œå¯ç”¨ Firestoreï¼ˆåŸç”Ÿæ¨¡å¼ï¼‰ä¸ Authenticationï¼ˆ<b>Anonymous</b>ï¼‰ã€‚</li>
        <li>å¤åˆ¶ä½ çš„ Web App é…ç½®ï¼Œç²˜è´´åˆ°æœ¬æ–‡æ¡£åº•éƒ¨çš„ <code>FIREBASE_CONFIG</code> å¤„ã€‚</li>
        <li>Firestore å®‰å…¨è§„åˆ™ï¼ˆä»…æœ¬äººå¯è¯»å†™ï¼‰ï¼š
<pre><code>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{uid}/vocab/{doc} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }
  }
}</code></pre>
        </li>
        <li>æŠŠæœ¬æ–‡ä»¶éƒ¨ç½²åˆ° GitHub Pages / Netlify / Cloudflare Pages ç­‰é™æ€æ‰˜ç®¡å³å¯ã€‚</li>
      </ol>
    </details>
  </section>

  <section class="card">
    <div class="row">
      <b>è¯è¡¨</b>
      <button class="btn alt" id="btnLoadSample">å¡«å……ç¤ºä¾‹</button>
      <input type="file" id="fileInput" accept=".csv,.txt,.json" class="btn alt" style="padding:8px 10px;background:#fff;border:1px solid #ddd" />
      <button class="btn" id="btnParse">è§£æåˆ°é¢˜åº“</button>
      <button class="btn alt" id="btnExportJSON">å¯¼å‡ºæœ¬åœ°å¤‡ä»½</button>
      <button class="btn danger" id="btnClearLocal">æ¸…é™¤æœ¬æœºæ•°æ®</button>
    </div>
    <textarea id="raw" placeholder="à¸£à¸±à¸,çˆ±,rak
à¸„à¸´à¸”à¸–à¸¶à¸‡,æƒ³å¿µ,kÃ­t-thÇ”eng
à¹€à¸£à¸µà¸¢à¸™,å­¦ä¹ ,rian
à¸ªà¸§à¸¢,æ¼‚äº®,sÇ”ai
à¹€à¸£à¹‡à¸§,å¿«,reo
à¸Šà¹‰à¸²,æ…¢,chÃ¡a"></textarea>
    <div class="muted">æ¯è¡Œ <b>æ³°è¯­,ä¸­æ–‡,è¯»éŸ³/å¤‡æ³¨(å¯é€‰)</b>ï¼›ä¹Ÿæ”¯æŒå¯¼å…¥ JSONã€‚</div>
  </section>

  <section class="card">
    <div class="row">
      <b>å‡ºé¢˜è®¾ç½®</b>
      <label><input type="radio" name="mode" value="mc" checked> é€‰æ‹©é¢˜</label>
      <label><input type="radio" name="mode" value="type"> å¡«ç©º</label>
      <label><input type="checkbox" id="caseTone"> å¡«ç©ºå¿½ç•¥å£°è°ƒ/å¤§å°å†™</label>
      <label><input type="checkbox" id="shuffle" checked> éšæœºé¡ºåº</label>
      <label>é€‰é¡¹æ•°
        <select id="optCount"><option>4</option><option>5</option><option>6</option></select>
      </label>
    </div>
    <div class="row">
      <b>æ–¹å‘</b>
      <label><input type="radio" name="dir" value="th2zh" checked> æ³° â†’ ä¸­</label>
      <label><input type="radio" name="dir" value="zh2th"> ä¸­ â†’ æ³°</label>
      <b>é¢˜æº</b>
      <label><input type="radio" name="scope" value="all" checked> å…¨éƒ¨</label>
      <label><input type="radio" name="scope" value="wrongs"> ä»…é”™é¢˜</label>
      <button class="btn accent" id="btnStart">å¼€å§‹æµ‹éªŒ</button>
      <button class="btn alt" id="btnReset" disabled>é‡ç½®</button>
    </div>
  </section>

  <section class="card" id="quiz" style="display:none">
    <div class="stats">
      <span class="pill" id="counter">0/0</span>
      <span>âœ”ï¸ <b id="ok">0</b>ã€€âŒ <b id="ng">0</b></span>
      <span>é”™é¢˜æœ¬ï¼š<b id="wrongSize">0</b> æ¡</span>
      <progress id="pg" max="100" value="0"></progress>
      <button class="btn alt" id="btnWrongRound" style="margin-left:auto">åªç»ƒé”™é¢˜</button>
    </div>
    <div class="prompt" id="prompt">â€”</div>
    <div id="reading" class="muted"></div>
    <div id="mc" class="grid"></div>
    <div id="typeBox" style="display:none">
      <input type="text" id="answer" placeholder="è¯·è¾“å…¥ç­”æ¡ˆâ€¦" autocomplete="off" />
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnCheck">åˆ¤åˆ†</button>
        <button class="btn alt" id="btnShow">æ˜¾ç¤ºç­”æ¡ˆ</button>
        <span class="muted" id="feedback"></span>
      </div>
    </div>
    <div class="row" style="margin-top:14px">
      <button class="btn" id="btnNext">ä¸‹ä¸€é¢˜</button>
    </div>
  </section>

  <section class="footer">
    <div>ğŸ“Œ äº‘ç«¯ä¿å­˜ä¸åŒæ­¥ä¾èµ– Firestoreï¼›æœ¬æœºä¹Ÿä¼šç”¨ <code>localStorage</code> åšç¦»çº¿å¤‡ä»½ã€‚</div>
    <div>ğŸ”’ æˆ‘åªå†™å…¥ <code>/users/{uid}/vocab/main</code>ï¼›å¯åœ¨å®‰å…¨è§„åˆ™ä¸­é”å®šä»…æœ¬äººå¯è¯»å†™ã€‚</div>
  </section>
</main>

<script type="module">
/** ============ é…ç½®åŒºï¼ˆè¯·ç²˜è´´ä½ è‡ªå·±çš„ Firebase é¡¹ç›®é…ç½®ï¼‰ ============ */
/*const FIREBASE_CONFIG = {
  apiKey: "PASTE_YOURS",
  authDomain: "PASTE_YOURS.firebaseapp.com",
  projectId: "PASTE_YOURS",
  storageBucket: "PASTE_YOURS.appspot.com",
  messagingSenderId: "PASTE_YOURS",
  appId: "PASTE_YOURS"
};
*/
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCOUufBRgdFnFO-OD819RtdE51mEQWfYd0",
  authDomain: "vocab-d3783.firebaseapp.com",
  projectId: "vocab-d3783",
  storageBucket: "vocab-d3783.firebasestorage.app",
  messagingSenderId: "330856057864",
  appId: "1:330856057864:web:1485b9cbf11e03ac2c15bd"
};
  
/** è¯æ¡æ•°é‡ä¸Šé™ï¼ˆè½¯é™åˆ¶ï¼Œå®¢æˆ·ç«¯æ ¡éªŒï¼›å¯åœ¨æœåŠ¡ç«¯ç”¨äº‘å‡½æ•°åšç¡¬é™åˆ¶ï¼‰ */
const ENTRY_LIMIT = 300;
document.getElementById('limit').textContent = ENTRY_LIMIT;

/** ============ å¼•å…¥ Firebase SDK ============ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

const app = initializeApp(FIREBASE_CONFIG);
const auth = getAuth(app);
const db = getFirestore(app);

/** ============ æœ¬åœ°çŠ¶æ€/å·¥å…·ï¼ˆä¸ç¦»çº¿ç‰ˆä¸€è‡´ï¼‰ ============ */
const LS_KEY = "thai_vocab_quiz_cloud";
let bank = [];      // [{cid, th, zh, note, ok, ng}]
let queue = [];
let idx = 0, ok = 0, ng = 0;
let wrongs = new Set();
let mode="mc", dir="th2zh", scope="all", optCount=4;
let user = null;

const $ = sel => document.querySelector(sel);
const $$ = sel => [...document.querySelectorAll(sel)];

function shuffle(a){ for(let j=a.length-1;j>0;j--){ const k=Math.floor(Math.random()*(j+1)); [a[j],a[k]]=[a[k],a[j]]; } return a; }
function reindexBank(){ bank = bank.map((x,i)=>({cid:i, th:x.th, zh:x.zh, note:x.note||"", ok:x.ok||0, ng:x.ng||0})); }
function setStats(){
  $('#counter').textContent = (Math.min(idx+1, queue.length))+'/'+queue.length;
  $('#ok').textContent = ok; $('#ng').textContent = ng;
  $('#pg').value = queue.length ? Math.round((idx/queue.length)*100) : 0;
  $('#wrongSize').textContent = wrongs.size;
}
function normalize(s){
  if(!s) return "";
  if($('#caseTone').checked){
    const map = {'Ã¡':'a','Ã ':'a','Ã¢':'a','Ç':'a','Ä':'a','Ã©':'e','Ã¨':'e','Ãª':'e','Ä›':'e','Ä“':'e','Ã­':'i','Ã¬':'i','Ã®':'i','Ç':'i','Ä«':'i','Ã³':'o','Ã²':'o','Ã´':'o','Ç’':'o','Å':'o','Ãº':'u','Ã¹':'u','Ã»':'u','Ç”':'u','Å«':'u','Ç˜':'u','Çœ':'u','Çš':'u','Ç–':'u'};
    s=[...s].map(ch=>map[ch]||ch).join('').toLowerCase();
  }
  return s.trim();
}
function parseCSV(text){
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const rows = [];
  for(const line of lines){
    let m = line.match(/^"(.*)","(.*)"(?:,"(.*)")?$/);
    if(m){ rows.push([m[1], m[2], m[3]||""]); continue; }
    const cols = [];
    let cur = "", inQ = false;
    for(let ch of line){
      if(ch === '"' ){ inQ = !inQ; continue; }
      if(ch === ',' && !inQ){ cols.push(cur.trim()); cur=""; }
      else cur+=ch;
    }
    cols.push(cur.trim());
    if(cols.length>=2) rows.push([cols[0], cols[1], cols[2]||""]);
  }
  return rows.map(r=>({th:r[0], zh:r[1], note:r[2]||""}));
}

function buildQueue(){
  let ids = bank.map(x=>x.cid);
  if(scope==='wrongs'){ ids = ids.filter(id=>wrongs.has(id)); if(ids.length===0){ alert('é”™é¢˜æœ¬ä¸ºç©º'); return false; } }
  queue = [...ids];
  if($('#shuffle').checked) shuffle(queue);
  idx=0; ok=0; ng=0;
  return true;
}

function startQuiz(){
  mode = $$('input[name="mode"]').find(x=>x.checked).value;
  dir  = $$('input[name="dir"]').find(x=>x.checked).value;
  scope = $$('input[name="scope"]').find(x=>x.checked).value;
  optCount = parseInt($('#optCount').value, 10);
  if(!bank.length){ alert('è¯·å…ˆè§£æè¯è¡¨'); return; }
  if(!buildQueue()) return;
  $('#quiz').style.display = '';
  $('#btnReset').disabled = false;
  nextQuestion();
  persistLocal();
}

function getCard(cid){ return bank.find(x=>x.cid===cid); }
function pickOptions(correctId){
  const pool = bank.map(x=>x.cid).filter(id=>id!==correctId);
  shuffle(pool);
  const picks = pool.slice(0, Math.max(0,optCount-1));
  return shuffle([correctId, ...picks]);
}
function renderMC(card){
  const container = $('#mc'); container.innerHTML=''; $('#typeBox').style.display='none'; container.style.display='grid';
  const opts = pickOptions(card.cid);
  for(const cid of opts){
    const it = getCard(cid);
    const text = (dir==='th2zh') ? it.zh : it.th;
    const div = document.createElement('button');
    div.className='option'; div.textContent=text;
    div.onclick = ()=> checkAnswer(cid===card.cid, card);
    container.appendChild(div);
  }
}
function renderType(card){
  $('#mc').style.display='none'; $('#typeBox').style.display=''; $('#answer').value=''; $('#feedback').textContent='';
}
function showPrompt(card){
  const prompt = (dir==='th2zh') ? card.th : card.zh;
  $('#prompt').textContent = prompt;
  $('#reading').textContent = card.note ? ('æç¤ºï¼š'+card.note) : '';
}
function lightSRSRequeue(card, wasCorrect){
  const stepBase = 4;
  if(!wasCorrect){
    const insertAt = Math.min(queue.length, idx + Math.max(2, stepBase - Math.min(3, card.ng)));
    queue.splice(insertAt, 0, card.cid);
  }else{
    if(wrongs.has(card.cid) && card.ok >= 2) wrongs.delete(card.cid);
  }
}
function checkAnswer(isCorrect, card){
  if(isCorrect){
    ok++; card.ok++; markButtons(card, true); lightSRSRequeue(card, true);
  }else{
    ng++; card.ng++; wrongs.add(card.cid); markButtons(card, false); lightSRSRequeue(card, false);
  }
  setStats(); persistLocal(); setTimeout(nextQuestion, 420);
}
function markButtons(card, wasCorrect){
  const target = (dir==='th2zh')?card.zh:card.th;
  [...$('#mc').children].forEach(b=>{
    if(b.textContent===target) b.classList.add('correct');
    else b.classList.add('wrong');
    b.disabled=true;
  });
}
function nextQuestion(){
  if(idx>=queue.length){
    $('#pg').value=100; $('#reading').textContent=''; $('#mc').innerHTML=''; $('#typeBox').style.display='none';
    $('#prompt').textContent = wrongs.size>0 ? `å®Œæˆï¼âœ”ï¸${ok} / âŒ${ng}ã€‚é”™é¢˜æœ¬ ${wrongs.size} æ¡ï¼Œå¯â€œåªç»ƒé”™é¢˜â€ã€‚` : `å®Œæˆï¼âœ”ï¸${ok} / âŒ${ng}ã€‚æ²¡æœ‰é”™é¢˜ï¼ŒçœŸæ£’ï¼`;
    return;
  }
  const cid = queue[idx++]; const card = getCard(cid);
  showPrompt(card); (mode==='mc') ? renderMC(card) : renderType(card); setStats();
}
function checkType(){
  const card = getCard(queue[idx-1]);
  const ans = $('#answer').value;
  const target = (dir==='th2zh') ? card.zh : card.th;
  const correct = normalize(ans)===normalize(target);
  if(correct){ $('#feedback').textContent='âœ… æ­£ç¡®ï¼'; ok++; card.ok++; lightSRSRequeue(card,true); }
  else { $('#feedback').textContent='âŒ æ­£ç¡®ï¼š'+target; ng++; card.ng++; wrongs.add(card.cid); lightSRSRequeue(card,false); }
  setStats(); persistLocal();
}
function wrongRound(){
  scope='wrongs'; $$('input[name="scope"]').forEach(x=>x.checked=(x.value==='wrongs'));
  if(!buildQueue()) return;
  $('#quiz').style.display=''; nextQuestion(); persistLocal();
}

/** æœ¬æœºå¤‡ä»½ï¼ˆlocalStorageï¼‰ */
function persistLocal(){
  const data = { bank, wrongs:[...wrongs], ts:Date.now() };
  localStorage.setItem(LS_KEY, JSON.stringify(data));
}
function restoreLocal(){
  const s = localStorage.getItem(LS_KEY); if(!s) return false;
  try{
    const d = JSON.parse(s);
    bank = d.bank||[]; wrongs = new Set(d.wrongs||[]); reindexBank(); setStats(); return bank.length>0;
  }catch(e){ return false; }
}

/** äº‘ç«¯ä¿å­˜/è½½å…¥ï¼ˆFirestoreï¼‰ */
async function cloudSave(){
  if(!user){ alert('è¯·å…ˆç™»å½•'); return; }
  if(bank.length > ENTRY_LIMIT){ alert('è¶…è¿‡ä¸Šé™ '+ENTRY_LIMIT+'ï¼Œè¯·åˆ å‡æˆ–åˆ†æ‰¹ä¿å­˜'); return; }
  const payload = { bank, wrongs:[...wrongs], updatedAt: new Date().toISOString() };
  const ref = doc(db, 'users', user.uid, 'vocab', 'main');
  await setDoc(ref, payload);
  alert('å·²ä¿å­˜åˆ°äº‘ç«¯');
}
async function cloudLoad(){
  if(!user){ alert('è¯·å…ˆç™»å½•'); return; }
  const ref = doc(db, 'users', user.uid, 'vocab', 'main');
  const snap = await getDoc(ref);
  if(!snap.exists()){ alert('äº‘ç«¯æš‚æ— æ•°æ®'); return; }
  const d = snap.data();
  bank = d.bank||[]; wrongs = new Set(d.wrongs||[]); reindexBank(); persistLocal();
  alert('å·²ä»äº‘ç«¯è¯»å– '+bank.length+' æ¡');
  setStats();
}

/** äº‹ä»¶ç»‘å®š */
$('#btnParse').addEventListener('click', ()=>{
  const val = $('#raw').value.trim();
  if(!val){ alert('è¯·å…ˆç²˜è´´è¯è¡¨'); return; }
  if(val.startsWith('{')){
    try{ const o = JSON.parse(val); bank = (o.bank||o)||[]; wrongs = new Set(o.wrongs||[]); }
    catch(e){ alert('JSON è§£æå¤±è´¥'); return; }
  }else{ bank = parseCSV(val); }
  if(bank.length > ENTRY_LIMIT){ alert('è¶…è¿‡ä¸Šé™ '+ENTRY_LIMIT+'ï¼Œå½“å‰ '+bank.length+' æ¡ã€‚è¯·åˆ å‡æˆ–åˆ†æ‰¹ã€‚'); return; }
  reindexBank(); alert('å·²è§£æ '+bank.length+' æ¡'); setStats(); persistLocal();
});
$('#btnLoadSample').addEventListener('click', ()=>{
  $('#raw').value = `à¸£à¸±à¸,çˆ±,rak
à¸„à¸´à¸”à¸–à¸¶à¸‡,æƒ³å¿µ,kÃ­t-thÇ”eng
à¹€à¸£à¸µà¸¢à¸™,å­¦ä¹ ,rian
à¸ªà¸§à¸¢,æ¼‚äº®,sÇ”ai
à¹€à¸£à¹‡à¸§,å¿«,reo
à¸Šà¹‰à¸²,æ…¢,chÃ¡a
à¸›à¸¥à¸­à¸šà¹ƒà¸ˆ,å®‰æ…°,plÉ”Ì€É”p-jai
à¸œà¸´à¸”à¸«à¸§à¸±à¸‡,å¤±æœ›,phit-wang`;
});
$('#btnReset').addEventListener('click', ()=>{ idx=0; ok=0; ng=0; queue=[]; $('#quiz').style.display='none'; $('#pg').value=0; $('#ok').textContent=0; $('#ng').textContent=0; setStats(); });
$('#btnStart').addEventListener('click', startQuiz);
$('#btnNext').addEventListener('click', nextQuestion);
$('#btnCheck').addEventListener('click', checkType);
$('#btnShow').addEventListener('click', ()=>{ const c=getCard(queue[idx-1]); const t=(dir==='th2zh')?c.zh:c.th; $('#feedback').textContent='ğŸ“ ç­”æ¡ˆï¼š'+t; });
$('#btnWrongRound').addEventListener('click', wrongRound);
$('#btnClearLocal').addEventListener('click', ()=>{ localStorage.removeItem(LS_KEY); wrongs.clear(); alert('å·²æ¸…é™¤æœ¬æœºæ•°æ®'); setStats(); });
$('#btnExportJSON').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify({ bank, wrongs:[...wrongs], ts:Date.now() }, null, 2)], {type:"application/json"});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='thai_vocab_quiz_backup.json'; a.click(); URL.revokeObjectURL(a.href);
});

/** è®¤è¯æ§åˆ¶ */
onAuthStateChanged(auth, (u)=>{
  user = u||null;
  $('#uid').textContent = user ? ('UID: '+user.uid) : 'æœªç™»å½•';
  $('#btnSignOut').disabled = !user;
  $('#btnCloudSave').disabled = !user;
  $('#btnCloudLoad').disabled = !user;
});
$('#btnSignIn').addEventListener('click', async ()=>{ await signInAnonymously(auth); alert('å·²ç™»å½•ï¼ˆåŒ¿åï¼‰'); });
$('#btnSignOut').addEventListener('click', async ()=>{ await signOut(auth); alert('å·²é€€å‡º'); });

// File input
$('#fileInput').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const txt = await f.text();
  if(f.name.endsWith('.json')){
    try{ const o = JSON.parse(txt); bank=(o.bank||o)||[]; wrongs=new Set(o.wrongs||[]); }
    catch(e){ alert('JSON è§£æå¤±è´¥'); return; }
  }else{ bank = parseCSV(txt); }
  if(bank.length > ENTRY_LIMIT){ alert('è¶…è¿‡ä¸Šé™ '+ENTRY_LIMIT+' æ¡'); return; }
  reindexBank(); alert('å·²è¯»å–ï¼š'+f.name+'ï¼ˆ'+bank.length+' æ¡ï¼‰'); setStats(); persistLocal();
});

// åˆå§‹å°è¯•ä»æœ¬åœ°æ¢å¤
restoreLocal();
</script>
</body>
</html>
