<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>æ³°è¯­â†”ä¸­æ–‡ èƒŒè¯å°æµ‹ Â· åœ¨çº¿ç‰ˆï¼ˆåŒ¿å + Google åŒæ­¥ v3ï¼‰</title>
<style>
  :root { --bg:#f6f7fb; --card:#ffffff; --text:#1f2328; --muted:#6a737d; --accent:#0a7; --danger:#c00; --warn:#b45309; }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans SC","PingFang SC","Hiragino Sans GB","Microsoft YaHei UI","Microsoft YaHei",sans-serif;line-height:1.6}
  header{position:sticky;top:0;background:linear-gradient(180deg,#fff,rgba(255,255,255,0.85));backdrop-filter:blur(6px);border-bottom:1px solid #eee;z-index:9}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  h1{font-size:20px;margin:8px 0}
  .card{background:var(--card);border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,0.04);padding:16px;margin:16px 0}
  textarea{width:100%;min-height:140px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;border-radius:10px;border:1px solid #ddd;padding:12px;box-sizing:border-box}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .btn{appearance:none;border:none;border-radius:10px;padding:10px 14px;cursor:pointer;background:#111;color:#fff}
  .btn.alt{background:#eaeef2;color:#111}
  .btn.accent{background:var(--accent);color:#fff}
  .btn.danger{background:var(--danger);color:#fff}
  .btn.warn{background:var(--warn);color:#fff}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .pill{padding:4px 8px;background:#eef2f7;border-radius:999px;font-size:12px}
  .muted{color:var(--muted);font-size:14px}
  .spinner{display:inline-block;width:14px;height:14px;border:2px solid #e5e7eb;border-top-color:#111;border-radius:50%;animation:spin 1s linear infinite;vertical-align:-2px}
  @keyframes spin{to{transform:rotate(360deg)}}
  .warn{color:var(--warn)} .ok{color:#0a7} .err{color:var(--danger)}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>æ³°è¯­â†”ä¸­æ–‡ èƒŒè¯å°æµ‹ Â· åœ¨çº¿ç‰ˆï¼ˆåŒ¿å + Google åŒæ­¥ v3ï¼‰</h1>
    <div class="muted">âœ… åŒ¿å/Google ç™»å½•ã€€âœ… äº‘ä¿å­˜/è¯»å–çŠ¶æ€æç¤ºã€€âœ… è‡ªåŠ¨åˆ†åŒ…ï¼ˆå¤§è¯åº“ï¼‰ã€€âœ… åˆå¹¶/è¦†ç›–ã€€âœ… é”™é¢˜æœ¬/è½»é‡SRS</div>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <div class="row">
      <b>ç™»å½•</b>
      <button class="btn accent" id="btnAnon">åŒ¿åç™»å½•</button>
      <button class="btn alt" id="btnGoogle">ç”¨ Google ç™»å½•</button>
      <button class="btn warn" id="btnLink">æŠŠå½“å‰åŒ¿åè´¦å·å‡çº§ä¸º Google</button>
      <button class="btn" id="btnSignOut" disabled>é€€å‡º</button>
      <span class="pill" id="uid">æœªç™»å½•</span>
      <span class="pill" id="provider">â€”</span>
    </div>
    <div class="row">
      <b>äº‘ç«¯</b>
      <button class="btn alt" id="btnSaveCover" disabled>ä¿å­˜åˆ°äº‘ç«¯ï¼ˆè¦†ç›–ï¼‰</button>
      <button class="btn alt" id="btnSaveMerge" disabled>ä¿å­˜åˆ°äº‘ç«¯ï¼ˆåˆå¹¶ï¼‰</button>
      <button class="btn alt" id="btnLoad" disabled>ä»äº‘ç«¯è¯»å–</button>
      <span class="pill" id="lastSync">ä¸Šæ¬¡åŒæ­¥ï¼šâ€”</span>
    </div>
    <div class="row">
      <span>å½“å‰è¯æ¡ï¼š<b id="bankSize">0</b> æ¡ï¼›ä¼°ç®— payloadï¼š<b id="payloadSize">0</b> KBï¼ˆå•æ–‡æ¡£ä¸Šé™çº¦ 1024 KBï¼‰</span>
      <span id="sizeWarn" class="warn"></span>
    </div>
    <div class="row">
      <span id="busy" style="display:none"><span class="spinner"></span> <span id="busyMsg">å¤„ç†ä¸­â€¦</span></span>
      <span><b>æç¤ºï¼š</b><span id="hint">â€”</span></span>
      <span><b>é”™è¯¯ï¼š</b><span id="err" class="err">â€”</span></span>
    </div>
  </section>

  <section class="card">
    <div class="row">
      <b>è¯è¡¨</b>
      <button class="btn alt" id="btnLoadSample">å¡«å……ç¤ºä¾‹</button>
      <input type="file" id="fileInput" accept=".csv,.txt,.json" class="btn alt" style="padding:8px 10px;background:#fff;border:1px solid #ddd" />
      <button class="btn" id="btnParse">è§£æåˆ°é¢˜åº“</button>
      <button class="btn alt" id="btnExportJSON">å¯¼å‡ºæœ¬åœ°å¤‡ä»½</button>
      <button class="btn danger" id="btnClearLocal">æ¸…é™¤æœ¬æœºæ•°æ®</button>
    </div>
    <textarea id="raw" placeholder="à¸£à¸±à¸,çˆ±,rak
à¸„à¸´à¸”à¸–à¸¶à¸‡,æƒ³å¿µ,kÃ­t-thÇ”eng
à¹€à¸£à¸µà¸¢à¸™,å­¦ä¹ ,rian
à¸ªà¸§à¸¢,æ¼‚äº®,sÇ”ai
à¹€à¸£à¹‡à¸§,å¿«,reo
à¸Šà¹‰à¸²,æ…¢,chÃ¡a"></textarea>
    <div class="muted">æ¯è¡Œ <b>æ³°è¯­,ä¸­æ–‡,è¯»éŸ³/å¤‡æ³¨(å¯é€‰)</b>ï¼›ä¹Ÿæ”¯æŒå¯¼å…¥ JSONã€‚</div>
  </section>

  <section class="footer">
    <div>ğŸ“Œ äº‘è·¯å¾„ï¼š<code>/users/{uid}/vocab/main</code>ï¼ˆå°è¯åº“ï¼‰ï¼›<code>/users/{uid}/vocab_packs/pack_*</code>ï¼ˆå¤§è¯åº“åˆ†åŒ…ï¼‰ï¼Œç´¢å¼•ï¼š<code>/users/{uid}/vocab_packs/index</code>ã€‚</div>
  </section>
</main>

<script type="module">
/** ===== é…ç½®ï¼šæ›¿æ¢ä¸ºä½ çš„ Firebase Web é…ç½® ===== */
const FIREBASE_CONFIG = {
  "apiKey": "AIzaSyCOUufBRgdFnFO-OD819RtdE51mEQWfYd0",
  "authDomain": "vocab-d3783.firebaseapp.com",
  "projectId": "vocab-d3783",
  "storageBucket": "vocab-d3783.firebasestorage.app",
  "messagingSenderId": "330856057864",
  "appId": "1:330856057864:web:1485b9cbf11e03ac2c15bd"
};

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import {
  getAuth, signInAnonymously, onAuthStateChanged, signOut,
  GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult,
  linkWithPopup, linkWithRedirect
} from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

const app = initializeApp(FIREBASE_CONFIG);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();
provider.setCustomParameters({ prompt: 'select_account' });

// Handle redirect result (for iOS/Safari)
getRedirectResult(auth).catch(e=>console.warn('redirect result error', e));

const $ = s=>document.querySelector(s);
function setBusy(on,msg){ $('#busy').style.display=on?'':'none'; $('#busyMsg').textContent=msg||'å¤„ç†ä¸­â€¦'; }
function setHint(msg){ $('#hint').textContent=msg||'â€”'; }
function setErr(e){ $('#err').textContent = e? (e.message||String(e)) : 'â€”'; }
function setLastSync(ts){ $('#lastSync').textContent='ä¸Šæ¬¡åŒæ­¥ï¼š'+(ts? new Date(ts).toLocaleString():'â€”'); }
function updateSizeInfo(){
  const encoder = new TextEncoder();
  const payload = { bank, wrongs:[...wrongs] };
  const bytes = encoder.encode(JSON.stringify(payload)).length;
  $('#bankSize').textContent = bank.length;
  $('#payloadSize').textContent = Math.round(bytes/1024);
  const warn = bytes > 900*1024 ? 'âš ï¸ é¢„è®¡è¶…è¿‡ Firestore å•æ–‡æ¡£å¤§å°ï¼Œä¿å­˜æ—¶ä¼šè‡ªåŠ¨åˆ†åŒ…ã€‚' : '';
  $('#sizeWarn').textContent = warn;
}
function isIOSorSafari(){
  const ua = navigator.userAgent;
  return /iPhone|iPad/i.test(ua) || (/Safari/i.test(ua) && !/Chrome|Chromium|CriOS|Android/i.test(ua));
}

/** ===== çŠ¶æ€ & æœ¬åœ°å­˜å‚¨ ===== */
let user=null;
let bank=[];
let wrongs=new Set();
const LS_KEY='thai_vocab_quiz_cloud';
function persistLocal(){
  localStorage.setItem(LS_KEY, JSON.stringify({bank, wrongs:[...wrongs], ts:Date.now()}));
  updateSizeInfo();
}
function restoreLocal(){
  const s=localStorage.getItem(LS_KEY); if(!s) return false;
  try{ const d=JSON.parse(s); bank=d.bank||[]; wrongs=new Set(d.wrongs||[]); updateSizeInfo(); return bank.length>0; }
  catch{ return false; }
}

/** ===== CSV/JSON è§£æ ===== */
function parseCSV(text){
  const lines=text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const rows=[];
  for(const line of lines){
    let m=line.match(/^"(.*)","(.*)"(?:,"(.*)")?$/);
    if(m){ rows.push([m[1],m[2],m[3]||""]); continue; }
    const cols=[]; let cur="",inQ=false;
    for(const ch of line){
      if(ch=='"'){ inQ=!inQ; continue; }
      if(ch==',' && !inQ){ cols.push(cur.trim()); cur=""; } else cur+=ch;
    }
    cols.push(cur.trim());
    if(cols.length>=2) rows.push([cols[0], cols[1], cols[2]||""]);
  }
  return rows.map(r=>({th:r[0], zh:r[1], note:r[2]||""}));
}

/** ===== äº‘ç«¯ä¿å­˜ï¼ˆè¦†ç›–/åˆ†åŒ… & åˆå¹¶ï¼‰ ===== */
function chunkArray(arr, size){ const out=[]; for(let i=0;i<arr.length;i+=size) out.push(arr.slice(i,i+size)); return out; }
async function saveAsMain(ref, payload){ await setDoc(ref, payload); }
async function saveAsPacks(items){
  const PACK_SIZE = 200;
  const packs = chunkArray(items, PACK_SIZE);
  const idxRef = doc(db, 'users', user.uid, 'vocab_packs', 'index');
  await setDoc(idxRef, { count:packs.length, updatedAt:Date.now() });
  for(let i=0;i<packs.length;i++){
    const pRef = doc(db, 'users', user.uid, 'vocab_packs', 'pack_'+(i+1));
    await setDoc(pRef, { bank:packs[i] });
  }
  await deleteDoc(doc(db, 'users', user.uid, 'vocab', 'main')).catch(()=>{});
}
async function cloudSave(mode='cover'){
  if(!user){ setHint('è¯·å…ˆç™»å½•'); return; }
  try{
    setBusy(true, 'æ­£åœ¨ä¿å­˜åˆ°äº‘ç«¯â€¦');
    toggleCloudButtons(true);
    let items = bank;
    if(mode==='merge'){
      const cloud = await cloudLoad(true);
      if(cloud && cloud.length){
        const map = new Map(cloud.map(x=>[x.th, x]));
        for(const it of bank){ map.set(it.th, it); }
        items = [...map.values()];
      }
    }
    const encoder = new TextEncoder();
    const bytes = encoder.encode(JSON.stringify({bank:items, wrongs:[...wrongs]})).length;
    if(bytes <= 900*1024){
      await saveAsMain(doc(db,'users',user.uid,'vocab','main'), { bank: items, wrongs:[...wrongs], updatedAt:Date.now() });
      await deleteDoc(doc(db,'users',user.uid,'vocab_packs','index')).catch(()=>{});
      setHint(`äº‘ä¿å­˜æˆåŠŸ âœ…ï¼ˆå•æ–‡æ¡£ï¼Œ${items.length} æ¡ï¼‰`);
    }else{
      await saveAsPacks(items);
      setHint(`äº‘ä¿å­˜æˆåŠŸ âœ…ï¼ˆå·²åˆ†åŒ…ï¼Œå…± ${items.length} æ¡ï¼‰`);
    }
    setErr(null); setLastSync(Date.now());
  }catch(e){
    setHint('äº‘ä¿å­˜å¤±è´¥ âŒ'); setErr(e);
  }finally{
    setBusy(false); toggleCloudButtons(false);
  }
}
function toggleCloudButtons(disabled){
  $('#btnSaveCover').disabled = disabled || !user;
  $('#btnSaveMerge').disabled = disabled || !user;
  $('#btnLoad').disabled = disabled || !user;
}

/** ===== äº‘ç«¯è¯»å–ï¼ˆè‡ªåŠ¨åˆå¹¶ main + packsï¼‰ ===== */
async function cloudLoad(silent=false){
  if(!user){ if(!silent) setHint('è¯·å…ˆç™»å½•'); return null; }
  try{
    if(!silent){ setBusy(true,'æ­£åœ¨ä»äº‘ç«¯è¯»å–â€¦'); toggleCloudButtons(true); }
    const mainRef = doc(db,'users',user.uid,'vocab','main');
    const mainSnap = await getDoc(mainRef);
    let items = [];
    if(mainSnap.exists()){
      const d = mainSnap.data();
      items = d.bank||[];
      wrongs = new Set(d.wrongs||[]);
      setLastSync(d.updatedAt||Date.now());
    }
    const idxRef = doc(db,'users',user.uid,'vocab_packs','index');
    const idxSnap = await getDoc(idxRef);
    if(idxSnap.exists()){
      const count = idxSnap.data().count||0;
      for(let i=1;i<=count;i++){
        const pRef = doc(db,'users',user.uid,'vocab_packs','pack_'+i);
        const pSnap = await getDoc(pRef);
        if(pSnap.exists()){
          const pb = pSnap.data().bank||[];
          items = items.concat(pb);
        }
      }
    }
    if(!silent){
      if(items.length===0){ setHint('äº‘ç«¯æš‚æ— æ•°æ®'); setErr(null); }
      else { setHint('äº‘è¯»å–æˆåŠŸï¼š'+items.length+' æ¡'); setErr(null); }
    }
    bank = items; persistLocal(); updateSizeInfo();
    return items;
  }catch(e){
    if(!silent){ setHint('äº‘è¯»å–å¤±è´¥ âŒ'); setErr(e); }
    return null;
  }finally{
    if(!silent){ setBusy(false); toggleCloudButtons(false); }
  }
}

/** ===== ç™»å½•ç›¸å…³ï¼šåŒ¿å / Google / åŒ¿åå‡çº§ä¸º Google ===== */
function showUser(u){
  $('#uid').textContent = u ? ('UID: '+u.uid) : 'æœªç™»å½•';
  const prov = u ? (u.isAnonymous ? 'åŒ¿å' : (u.providerData[0]?.providerId||'å·²ç™»å½•')) : 'â€”';
  $('#provider').textContent = 'èº«ä»½ï¼š'+prov;
  const on = !!u;
  $('#btnSignOut').disabled = !on;
  toggleCloudButtons(!on);
}
onAuthStateChanged(auth, (u)=>{
  user=u||null; showUser(user);
  if(user){ cloudLoad(true).then(items=>{ if(items) setHint('ç™»å½•æˆåŠŸï¼Œå·²å°è¯•è½½å…¥äº‘ç«¯æ•°æ®'); }); }
});

$('#btnAnon').onclick = async()=>{
  try{ setBusy(true,'åŒ¿åç™»å½•ä¸­â€¦'); await signInAnonymously(auth); setHint('åŒ¿åç™»å½•æˆåŠŸ'); }
  catch(e){ setHint('åŒ¿åç™»å½•å¤±è´¥'); setErr(e); }
  finally{ setBusy(false); }
};

async function googleLogin(){
  try{
    setBusy(true, 'Google ç™»å½•ä¸­â€¦');
    if(isIOSorSafari()){ await signInWithRedirect(auth, provider); }
    else { await signInWithPopup(auth, provider); }
    setHint('Google ç™»å½•æˆåŠŸ');
  }catch(e){
    setHint('Google ç™»å½•å¤±è´¥'); setErr(e);
  }finally{ setBusy(false); }
}
$('#btnGoogle').onclick = googleLogin;

async function linkGoogle(){
  try{
    const u = auth.currentUser;
    if(!u){ alert('è¯·å…ˆåŒ¿åç™»å½•'); return; }
    if(!u.isAnonymous){ alert('å½“å‰ä¸æ˜¯åŒ¿åè´¦å·ï¼Œæ— éœ€å‡çº§'); return; }
    setBusy(true, 'å‡çº§ä¸º Google ä¸­â€¦');
    if(isIOSorSafari()){ await linkWithRedirect(u, provider); }
    else { await linkWithPopup(u, provider); }
    setHint('å·²å°†åŒ¿åè´¦å·å‡çº§ä¸º Google è´¦å·ï¼ˆuid ä¸å˜ï¼Œæ•°æ®ä¿ç•™ï¼‰');
  }catch(e){
    if(e.code === 'auth/credential-already-in-use' || e.code === 'auth/account-exists-with-different-credential'){
      setHint('è¯¥ Google è´¦å·å·²ç»‘å®šå…¶ä»–ç”¨æˆ·ï¼šå¯å…ˆç”¨è¯¥è´¦å·ç™»å½•è¯»å–å…¶æ•°æ®ï¼›å¦‚éœ€åˆå¹¶ï¼Œè¯·å…ˆå¯¼å‡º JSON å†å¯¼å…¥åˆå¹¶ä¿å­˜ã€‚');
    }else{
      setHint('å‡çº§å¤±è´¥'); setErr(e);
    }
  }finally{ setBusy(false); }
}
$('#btnLink').onclick = linkGoogle;

$('#btnSignOut').onclick = async()=>{
  try{ await signOut(auth); setHint('å·²é€€å‡º'); setLastSync(null); }
  catch(e){ setHint('é€€å‡ºå¤±è´¥'); setErr(e); }
};

/** ===== æœ¬åœ°å¯¼å…¥/å¯¼å‡º ===== */
$('#btnParse').onclick = ()=>{
  const val = $('#raw').value.trim();
  if(!val){ alert('è¯·å…ˆç²˜è´´è¯è¡¨'); return; }
  if(val.startsWith('{')){
    try{ const o=JSON.parse(val); bank=(o.bank||o)||[]; wrongs=new Set(o.wrongs||[]); }
    catch(e){ alert('JSON è§£æå¤±è´¥'); return; }
  }else{ bank = parseCSV(val); }
  alert('å·²è§£æ '+bank.length+' æ¡'); persistLocal();
};
$('#btnLoadSample').onclick = ()=>{
  $('#raw').value = `à¸£à¸±à¸,çˆ±,rak
à¸„à¸´à¸”à¸–à¸¶à¸‡,æƒ³å¿µ,kÃ­t-thÇ”eng
à¹€à¸£à¸µà¸¢à¸™,å­¦ä¹ ,rian
à¸ªà¸§à¸¢,æ¼‚äº®,sÇ”ai
à¹€à¸£à¹‡à¸§,å¿«,reo
à¸Šà¹‰à¸²,æ…¢,chÃ¡a`;
};
$('#fileInput').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const txt = await f.text();
  if(f.name.endsWith('.json')){
    try{ const o = JSON.parse(txt); bank=(o.bank||o)||[]; wrongs=new Set(o.wrongs||[]); }
    catch(e){ alert('JSON è§£æå¤±è´¥'); return; }
  }else{ bank = parseCSV(txt); }
  alert('å·²è¯»å–ï¼š'+f.name+'ï¼ˆ'+bank.length+' æ¡ï¼‰'); persistLocal();
});
$('#btnClearLocal').onclick = ()=>{ localStorage.removeItem(LS_KEY); wrongs.clear(); bank=[]; updateSizeInfo(); alert('å·²æ¸…é™¤æœ¬æœºæ•°æ®'); };
$('#btnExportJSON').onclick = ()=>{
  const blob = new Blob([JSON.stringify({bank, wrongs:[...wrongs], ts:Date.now()}, null, 2)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='thai_vocab_quiz_backup.json'; a.click(); URL.revokeObjectURL(a.href);
};

// åˆå§‹ï¼šå°è¯•ä»æœ¬åœ°æ¢å¤
restoreLocal(); updateSizeInfo();
</script>
</body>
</html>
